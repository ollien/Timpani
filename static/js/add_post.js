function canLoadInsignia(){return null!=window.navigator&&!(navigator.userAgent.indexOf("MSIE")>-1&&navigator.userAgent.indexOf("MSIE 11")===-1&&navigator.userAgent.indexOf("Opera")===-1)}var INSIGNIA_OPTIONS={validate:function(e,t){return e.indexOf("#")===-1}};document.addEventListener("DOMContentLoaded",function(e){function t(){i.getLength()<=1?a.setCustomValidity("Please fill out a post body."):a.setCustomValidity("")}var n=document.getElementById("editor"),i=new Quill(n),l=ace.edit("code-editor"),d=document.getElementById("post-body"),a=document.getElementById("post-validity"),o=document.getElementById("tags-input"),u=document.getElementById("placeholder-tags-input"),s=canLoadInsignia()?insignia(o,INSIGNIA_OPTIONS):null,r=document.getElementById("post-form"),c=document.getElementById("add-link"),v=document.getElementById("add-image"),m=document.getElementById("add-quote"),g=document.getElementById("add-code"),p=document.getElementById("align-left"),f=document.getElementById("align-center"),I=document.getElementById("align-right"),E=document.getElementById("align-justify"),L=document.getElementById("link-modal");linkModal=new Modal(L),linkModal.input=document.getElementById("modal-link"),linkModal.errorDiv=linkModal.element.querySelector("div.modal-error"),linkModal.positiveButton=linkModal.element.querySelector("button.positive");var k=document.getElementById("image-modal"),y=new Modal(k);y.linkInput=document.getElementById("image-url"),y.fileInput=document.getElementById("image-upload"),y.uploadRequest=null,y.positiveButton=y.element.querySelector("button.positive"),y.errorDiv=y.element.querySelector("div.modal-error");var b=document.getElementById("code-modal"),B=new Modal(b,{keyboard:!1});B.selectLanguage=document.getElementById("select-language"),B.positiveButton=B.element.querySelector("button-positive"),a.setCustomValidity("Please fill out a post body."),i.addModule("toolbar",{container:"div#toolbar"}),i.addFormat("quote",{"class":"quote"}),i.addFormat("code",{"class":"language-"}),l.getSession().setUseWorker(!1),t(),i.on("selection-change",function(e){null==e?(n.classList.remove("focused"),m.disabled=!0,g.disabled=!1):(n.classList.add("focused"),e.end-e.start>0?(m.disabled=!1,g.disabled=!0):(m.disabled=!0,g.disabled=!1))}),i.on("text-change",function(){var e=i.getSelection();null==e||e.end-e.start===0?(m.disabled=!0,g.disabled=!1):(m.disabled=!1,g.disabled=!0),t()}),c.addEventListener("click",function(e){linkModal.show(),linkModal.input.focus()}),v.addEventListener("click",function(e){y.show()}),g.addEventListener("click",function(e){B.show()}),p.addEventListener("click",function(e){i.focus();var t=i.getSelection();null!=t&&i.formatLine(t.start,t.end,"align","left")}),f.addEventListener("click",function(e){i.focus();var t=i.getSelection();null!=t&&i.formatLine(t.start,t.end,"align","center")}),I.addEventListener("click",function(e){i.focus();var t=i.getSelection();null!=t&&i.formatLine(t.start,t.end,"align","right")}),E.addEventListener("click",function(e){i.focus();var t=i.getSelection();null!=t&&i.formatText(t.start,t.end+1,"align","justify")}),linkModal.element.addEventListener("show",function(e){linkModal.input.value="",linkModal.errorDiv.classList.remove("active")}),linkModal.element.addEventListener("positive-pressed",function(e){if(0===linkModal.input.value.trim().length)linkModal.errorDiv.classList.add("active"),e.preventDefault();else{i.focus();var t=i.getSelection();i.setSelection(null);var n=linkModal.input.value.trim();n.match(/^.+:\/\//)||(n="//"+n),t.end-t.start===0?i.insertText(t.start,linkModal.input.value,"link",n):i.formatText(t.start,t.end,"link",n)}}),linkModal.element.addEventListener("hide",function(e){linkModal.positiveButton.blur()}),y.element.addEventListener("show",function(e){y.linkInput.disabled=!1,y.linkInput.value="",y.fileInput.disabled=!1,y.fileInput.value=null,y.positiveButton.classList.remove("uploading"),y.positiveButton.disabled=!1,y.errorDiv.classList.remove("active")}),y.linkInput.addEventListener("input",function(e){y.fileInput.disabled=0!==y.linkInput.value.length}),y.fileInput.addEventListener("change",function(e){y.linkInput.disabled=!0}),y.element.addEventListener("positive-pressed",function(e){if(!y.linkInput.disabled&&y.linkInput.value.length>0){i.focus();var t=i.getSelection();i.insertEmbed(t.end,"image",y.linkInput.value)}else if(!y.fileInput.disabled&&y.fileInput.value.length>0){e.preventDefault(),y.uploadRequest=new XMLHttpRequest;var n=new FormData;n.append("image",y.fileInput.files[0]),y.uploadRequest.open("POST","/upload_image"),y.uploadRequest.onload=function(){var e=JSON.parse(y.uploadRequest.responseText);if(0===e.error){i.focus();var t=i.getSelection();i.insertEmbed(t.end,"image",e.url),y.hide()}else 2===e.error&&(y.errorDiv.textContent="Image must be a JPG, PNG, or GIF.",y.errorDiv.classList.add("active"),y.positiveButton.classList.remove("uploading"),y.positiveButton.disabled=!1);y.uploadRequest=null},y.uploadRequest.send(n),y.positiveButton.classList.add("uploading"),y.positiveButton.disabled=!0}}),y.element.addEventListener("hide",function(e){y.positiveButton.blur(),null!=y.uploadRequest&&y.uploadRequest.abort()}),B.element.addEventListener("show",function(e){i.setSelection(null),B.selectLanguage.selectedIndex="0",l.setValue(""),l.focus()}),B.selectLanguage.addEventListener("change",function(e){l.getSession().setMode("ace/mode/"+B.selectLanguage.value)}),B.element.addEventListener("positive-pressed",function(e){i.focus();var t=i.getSelection();i.setSelection(null);for(var n=l.getValue().split("\n"),d=0;d<n.length;d++)0===n[d].length&&(n[d]="  ");n=n.join("\n"),i.insertText(t.end,n,"code",B.selectLanguage.value)}),B.element.addEventListener("hide",function(e){B.positiveButton.blur(),l.getSession().setMode("ace/mode/plain_text")}),o.addEventListener("focus",function(e){var t=document.getElementById("tag-input-div");t.classList.add("focused")}),o.addEventListener("blur",function(e){var t=document.getElementById("tag-input-div");t.classList.remove("focused")}),r.addEventListener("submit",function(e){d.value=i.getHTML(),canLoadInsignia()?u.value=s.value():u.value=o.value})});