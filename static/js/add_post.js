function canLoadInsignia(){return null!=window.navigator&&!(navigator.userAgent.indexOf("MSIE")>-1&&navigator.userAgent.indexOf("MSIE 11")===-1&&navigator.userAgent.indexOf("Opera")===-1)}var INSIGNIA_OPTIONS={validate:function(e,t){return e.indexOf("#")===-1}};document.addEventListener("DOMContentLoaded",function(e){function t(){d.getLength()<=1?a.setCustomValidity("Please fill out a post body."):a.setCustomValidity("")}function n(e,t){e.abort(),t.classList.remove("working"),t.disabled=!1}var i=document.getElementById("editor"),d=new Quill(i),l=ace.edit("code-editor"),o=document.getElementById("post-body"),a=document.getElementById("post-validity"),s=document.getElementById("tags-input"),u=document.getElementById("placeholder-tags-input"),r=canLoadInsignia()?insignia(s,INSIGNIA_OPTIONS):null,c=document.getElementById("post-form"),v=document.getElementById("add-link"),m=document.getElementById("add-image"),g=document.getElementById("add-quote"),p=document.getElementById("add-code"),f=document.getElementById("align-left"),I=document.getElementById("align-center"),E=document.getElementById("align-right"),L=document.getElementById("align-justify"),b=document.getElementById("link-modal"),y=new Modal(b);y.input=document.getElementById("modal-link"),y.errorDiv=y.element.querySelector("div.modal-error"),y.positiveButton=y.element.querySelector("button.positive");var B=document.getElementById("image-modal"),S=new Modal(B);S.linkInput=document.getElementById("image-url"),S.fileInput=document.getElementById("image-upload"),S.uploadRequest=null,S.positiveButton=S.element.querySelector("button.positive"),S.errorDiv=S.element.querySelector("div.modal-error");var k=document.getElementById("code-modal"),h=new Modal(k,{keyboard:!1});h.selectLanguage=document.getElementById("select-language"),h.positiveButton=h.element.querySelector("button-positive"),a.setCustomValidity("Please fill out a post body."),d.addModule("toolbar",{container:"div#toolbar"}),d.addFormat("quote",{"class":"quote"}),d.addFormat("code",{"class":"language-"}),l.getSession().setUseWorker(!1),t(),d.on("selection-change",function(e){null==e?(i.classList.remove("focused"),g.disabled=!0,p.disabled=!1):(i.classList.add("focused"),e.end-e.start>0?(g.disabled=!1,p.disabled=!0):(g.disabled=!0,p.disabled=!1))}),d.on("text-change",function(){var e=d.getSelection();null==e||e.end-e.start===0?(g.disabled=!0,p.disabled=!1):(g.disabled=!1,p.disabled=!0),t()}),v.addEventListener("click",function(e){y.show(),y.input.focus()}),m.addEventListener("click",function(e){S.show()}),p.addEventListener("click",function(e){h.show()}),f.addEventListener("click",function(e){d.focus();var t=d.getSelection();null!=t&&d.formatLine(t.start,t.end,"align","left")}),I.addEventListener("click",function(e){d.focus();var t=d.getSelection();null!=t&&d.formatLine(t.start,t.end,"align","center")}),E.addEventListener("click",function(e){d.focus();var t=d.getSelection();null!=t&&d.formatLine(t.start,t.end,"align","right")}),L.addEventListener("click",function(e){d.focus();var t=d.getSelection();null!=t&&d.formatText(t.start,t.end+1,"align","justify")}),y.element.addEventListener("show",function(e){y.input.value="",y.errorDiv.classList.remove("active")}),y.element.addEventListener("positive-pressed",function(e){if(0===y.input.value.trim().length)y.errorDiv.classList.add("active"),e.preventDefault();else{d.focus();var t=d.getSelection();d.setSelection(null);var n=y.input.value.trim();n.match(/^.+:\/\//)||(n="//"+n),t.end-t.start===0?d.insertText(t.start,y.input.value,"link",n):d.formatText(t.start,t.end,"link",n)}}),y.element.addEventListener("hide",function(e){y.positiveButton.blur()}),S.element.addEventListener("show",function(e){S.linkInput.disabled=!1,S.linkInput.value="",S.fileInput.disabled=!1,S.fileInput.value=null,S.positiveButton.classList.remove("working"),S.positiveButton.disabled=!1,S.errorDiv.classList.remove("active")}),S.linkInput.addEventListener("input",function(e){S.fileInput.disabled=0!==S.linkInput.value.length}),S.fileInput.addEventListener("change",function(e){S.linkInput.disabled=!0}),S.element.addEventListener("positive-pressed",function(e){if(!S.linkInput.disabled&&S.linkInput.value.length>0){d.focus();var t=d.getSelection();d.insertEmbed(t.end,"image",S.linkInput.value)}else if(!S.fileInput.disabled&&S.fileInput.value.length>0){e.preventDefault(),S.uploadRequest=new XMLHttpRequest;var i=new FormData;i.append("image",S.fileInput.files[0]),S.uploadRequest.open("POST","/upload_image"),S.uploadRequest.onload=function(){var e=JSON.parse(S.uploadRequest.responseText);if(0===e.error){d.focus();var t=d.getSelection();d.insertEmbed(t.end,"image",e.url),S.hide()}else 2===e.error&&(S.errorDiv.textContent="Image must be a JPG, PNG, or GIF.",S.errorDiv.classList.add("active"),S.positiveButton.classList.remove("working"),S.positiveButton.disabled=!1);S.uploadRequest=null},this.addEventListener("neutral-pressed",function(e){n(S.uploadRequest,S.positiveButton)}),S.uploadRequest.send(i),S.positiveButton.classList.add("working"),S.positiveButton.disabled=!0}}),S.element.addEventListener("hide",function(e){S.positiveButton.blur(),null!=S.uploadRequest&&S.uploadRequest.abort()}),h.element.addEventListener("show",function(e){d.setSelection(null),h.selectLanguage.selectedIndex="0",l.setValue(""),l.focus()}),h.selectLanguage.addEventListener("change",function(e){l.getSession().setMode("ace/mode/"+h.selectLanguage.value)}),h.element.addEventListener("positive-pressed",function(e){d.focus();var t=d.getSelection();d.setSelection(null);for(var n=l.getValue().split("\n"),i=0;i<n.length;i++)0===n[i].length&&(n[i]="  ");n=n.join("\n"),d.insertText(t.end,n,"code",h.selectLanguage.value)}),h.element.addEventListener("hide",function(e){h.positiveButton.blur(),l.getSession().setMode("ace/mode/plain_text")}),s.addEventListener("focus",function(e){var t=document.getElementById("tag-input-div");t.classList.add("focused")}),s.addEventListener("blur",function(e){var t=document.getElementById("tag-input-div");t.classList.remove("focused")}),c.addEventListener("submit",function(e){o.value=d.getHTML(),canLoadInsignia()?u.value=r.value():u.value=s.value})});