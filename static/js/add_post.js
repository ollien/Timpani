function canLoadInsignia(){return null!=window.navigator&&!(navigator.userAgent.indexOf("MSIE")>-1&&navigator.userAgent.indexOf("MSIE 11")===-1&&navigator.userAgent.indexOf("Opera")===-1)}var INSIGNIA_OPTIONS={validate:function(e,t){return e.indexOf("#")===-1}};document.addEventListener("DOMContentLoaded",function(e){function t(){i.getLength()<=1?o.setCustomValidity("Please fill out a post body."):o.setCustomValidity("")}var n=document.getElementById("editor"),i=new Quill(n),l=ace.edit("code-editor"),d=document.getElementById("post-body"),o=document.getElementById("post-validity"),a=document.getElementById("tags-input"),u=document.getElementById("placeholder-tags-input"),s=canLoadInsignia()?insignia(a,INSIGNIA_OPTIONS):null,r=document.getElementById("post-form"),c=document.getElementById("add-link"),v=document.getElementById("add-image"),m=document.getElementById("add-quote"),g=document.getElementById("add-code"),p=document.getElementById("align-left"),f=document.getElementById("align-center"),I=document.getElementById("align-right"),E=document.getElementById("align-justify"),L=document.getElementById("link-modal"),y=new Modal(L);y.input=document.getElementById("modal-link"),y.errorDiv=y.element.querySelector("div.modal-error"),y.positiveButton=y.element.querySelector("button.positive");var b=document.getElementById("image-modal"),B=new Modal(b);B.linkInput=document.getElementById("image-url"),B.fileInput=document.getElementById("image-upload"),B.uploadRequest=null,B.positiveButton=B.element.querySelector("button.positive"),B.errorDiv=B.element.querySelector("div.modal-error");var S=document.getElementById("code-modal"),k=new Modal(S,{keyboard:!1});k.selectLanguage=document.getElementById("select-language"),k.positiveButton=k.element.querySelector("button-positive"),o.setCustomValidity("Please fill out a post body."),i.addModule("toolbar",{container:"div#toolbar"}),i.addFormat("quote",{"class":"quote"}),i.addFormat("code",{"class":"language-"}),l.getSession().setUseWorker(!1),t(),i.on("selection-change",function(e){null==e?(n.classList.remove("focused"),m.disabled=!0,g.disabled=!1):(n.classList.add("focused"),e.end-e.start>0?(m.disabled=!1,g.disabled=!0):(m.disabled=!0,g.disabled=!1))}),i.on("text-change",function(){var e=i.getSelection();null==e||e.end-e.start===0?(m.disabled=!0,g.disabled=!1):(m.disabled=!1,g.disabled=!0),t()}),c.addEventListener("click",function(e){y.show(),y.input.focus()}),v.addEventListener("click",function(e){B.show()}),g.addEventListener("click",function(e){k.show()}),p.addEventListener("click",function(e){i.focus();var t=i.getSelection();null!=t&&i.formatLine(t.start,t.end,"align","left")}),f.addEventListener("click",function(e){i.focus();var t=i.getSelection();null!=t&&i.formatLine(t.start,t.end,"align","center")}),I.addEventListener("click",function(e){i.focus();var t=i.getSelection();null!=t&&i.formatLine(t.start,t.end,"align","right")}),E.addEventListener("click",function(e){i.focus();var t=i.getSelection();null!=t&&i.formatText(t.start,t.end+1,"align","justify")}),y.element.addEventListener("show",function(e){y.input.value="",y.errorDiv.classList.remove("active")}),y.element.addEventListener("positive-pressed",function(e){if(0===y.input.value.trim().length)y.errorDiv.classList.add("active"),e.preventDefault();else{i.focus();var t=i.getSelection();i.setSelection(null);var n=y.input.value.trim();n.match(/^.+:\/\//)||(n="//"+n),t.end-t.start===0?i.insertText(t.start,y.input.value,"link",n):i.formatText(t.start,t.end,"link",n)}}),y.element.addEventListener("hide",function(e){y.positiveButton.blur()}),B.element.addEventListener("show",function(e){B.linkInput.disabled=!1,B.linkInput.value="",B.fileInput.disabled=!1,B.fileInput.value=null,B.positiveButton.classList.remove("working"),B.positiveButton.disabled=!1,B.errorDiv.classList.remove("active")}),B.linkInput.addEventListener("input",function(e){B.fileInput.disabled=0!==B.linkInput.value.length}),B.fileInput.addEventListener("change",function(e){B.linkInput.disabled=!0}),B.element.addEventListener("positive-pressed",function(e){if(!B.linkInput.disabled&&B.linkInput.value.length>0){i.focus();var t=i.getSelection();i.insertEmbed(t.end,"image",B.linkInput.value)}else if(!B.fileInput.disabled&&B.fileInput.value.length>0){e.preventDefault(),B.uploadRequest=new XMLHttpRequest;var n=new FormData;n.append("image",B.fileInput.files[0]),B.uploadRequest.open("POST","/upload_image"),B.uploadRequest.onload=function(){var e=JSON.parse(B.uploadRequest.responseText);if(0===e.error){i.focus();var t=i.getSelection();i.insertEmbed(t.end,"image",e.url),B.hide()}else 2===e.error&&(B.errorDiv.textContent="Image must be a JPG, PNG, or GIF.",B.errorDiv.classList.add("active"),B.positiveButton.classList.remove("working"),B.positiveButton.disabled=!1);B.uploadRequest=null},B.uploadRequest.send(n),B.positiveButton.classList.add("working"),B.positiveButton.disabled=!0}}),B.element.addEventListener("hide",function(e){B.positiveButton.blur(),null!=B.uploadRequest&&B.uploadRequest.abort()}),k.element.addEventListener("show",function(e){i.setSelection(null),k.selectLanguage.selectedIndex="0",l.setValue(""),l.focus()}),k.selectLanguage.addEventListener("change",function(e){l.getSession().setMode("ace/mode/"+k.selectLanguage.value)}),k.element.addEventListener("positive-pressed",function(e){i.focus();var t=i.getSelection();i.setSelection(null);for(var n=l.getValue().split("\n"),d=0;d<n.length;d++)0===n[d].length&&(n[d]="  ");n=n.join("\n"),i.insertText(t.end,n,"code",k.selectLanguage.value)}),k.element.addEventListener("hide",function(e){k.positiveButton.blur(),l.getSession().setMode("ace/mode/plain_text")}),a.addEventListener("focus",function(e){var t=document.getElementById("tag-input-div");t.classList.add("focused")}),a.addEventListener("blur",function(e){var t=document.getElementById("tag-input-div");t.classList.remove("focused")}),r.addEventListener("submit",function(e){d.value=i.getHTML(),canLoadInsignia()?u.value=s.value():u.value=a.value})});