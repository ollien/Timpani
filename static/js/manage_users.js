var PASSWORDS_DO_NOT_MATCH="Passwords do not match.";document.addEventListener("DOMContentLoaded",function(e){function t(e){e.addEventListener("click",function(e){u.show(),D=this.parentNode.getAttribute("user_id");var t=new XMLHttpRequest;t.open("GET","/get_user_info/"+D),t.addEventListener("load",function(e){var n=JSON.parse(t.responseText);0===n.error?(S.textContent=n.info.username,C.textContent=n.info.full_name,0===n.info.permissions.length?(A.style.display="",I.style.display="none"):(A.style.display="none",I.style.display="",O.style.display=n.info.permissions.indexOf("can_write_posts")>-1?"":"none",k.style.display=n.info.permissions.indexOf("can_change_settings")>-1?"":"none")):1===n.error&&(window.location="/login")}),t.send()})}function n(e,t){e.abort(),t.classList.remove("working"),t.disabled=!1}function s(e){userElements=p.querySelectorAll("li.user");for(var t=0;t<userElements.length;t++)if(userElements[t].querySelector("span.username").textContent.toLowerCase()>e.toLowerCase())return userElements[t];return null}var i=document.getElementById("add-user-modal"),o=document.getElementById("user-info-modal"),d=document.getElementById("change-password-modal"),a=document.getElementById("edit-permissions-modal"),r=new Modal(i);r.positiveButton=r.element.querySelector("button.positive");var u=new Modal(o);u.positiveButton=r.element.querySelector("button.positive");var l=new Modal(d);l.positiveButton=l.element.querySelector("button.positive");var c=new Modal(a);c.positiveButton=c.element.querySelector("button.positive");var m=document.getElementById("add-user-button"),p=document.getElementById("users-list"),v=document.getElementById("create-user-form"),y=v.querySelector("button"),g=Array.prototype.slice.call(document.querySelectorAll(".user-info-button")),f=document.getElementById("change-password-button"),E=document.getElementById("edit-permissions-button"),h=document.getElementById("username-input"),w=document.getElementById("full-name-input"),B=document.getElementById("password-input"),L=document.getElementById("confirm-password-input"),b=document.getElementById("can-change-settings-checkbox"),_=document.getElementById("can-write-posts-checkbox"),S=document.getElementById("username-display"),C=document.getElementById("full-name-display"),I=document.getElementById("permission-info"),O=document.getElementById("can-change-settings"),k=document.getElementById("can-write-posts"),A=document.getElementById("no-permissions"),D=-1,T=document.getElementById("reset-password-input"),x=document.getElementById("confirm-password-reset-input"),V=document.getElementById("change-password-form"),M=V.querySelector("button"),q=document.getElementById("can-change-settings-edit-checkbox"),H=document.getElementById("can-write-posts-edit-checkbox");m.addEventListener("click",function(e){r.show()}),v.addEventListener("submit",function(e){r.positiveButton.classList.add("working"),r.positiveButton.disabled=!0,e.preventDefault(),v.checkValidity();var i=new FormData;i.append(h.getAttribute("name"),h.value),i.append(w.getAttribute("name"),w.value),i.append(B.getAttribute("name"),B.value),b.checked&&i.append(b.getAttribute("name"),"on"),_.checked&&i.append(_.getAttribute("name"),"on");var o=new XMLHttpRequest;o.open("POST","/create_user"),o.addEventListener("load",function(e){var n=JSON.parse(o.responseText);if(r.positiveButton.classList.remove("working"),r.positiveButton.disabled=!1,0===n.error){var i=n.user_id,d=document.createElement("li");d.setAttribute("user_id",i),d.classList.add("user");var a=document.createElement("span");a.classList.add("username"),a.textContent=h.value,d.appendChild(a);var u=document.createElement("span");u.classList.add("user-info-button"),u.classList.add("fa"),u.classList.add("fa-info-circle"),g.push(u),t(u),d.appendChild(u),d.style.opacity=0,d.style.height="0px";var l=s(h.value);null===l?p.appendChild(d):p.insertBefore(d,l),window.getComputedStyle(d).opacity,window.getComputedStyle(d).height,d.style.opacity=1,d.style.height="",r.hide()}else 1===n.error?window.location="/login":2===n.error&&(h.setCustomValidity("Username already in use!"),y.click())}),r.element.addEventListener("neutral-pressed",function(e){n(o,r.positiveButton)}),o.send(i)}),h.addEventListener("input",function(e){this.setCustomValidity("")}),B.addEventListener("input",function(e){this.setCustomValidity(""),this.value!==L.value&&this.setCustomValidity(PASSWORDS_DO_NOT_MATCH)}),L.addEventListener("input",function(e){B.setCustomValidity(""),B.value!==this.value&&B.setCustomValidity(PASSWORDS_DO_NOT_MATCH)}),r.element.addEventListener("positive-pressed",function(e){e.preventDefault(),y.click()}),r.element.addEventListener("hide",function(e){v.reset(),B.setCustomValidity(""),L.setCustomValidity(""),h.setCustomValidity("")}),g.forEach(t),f.addEventListener("click",function(e){l.show()}),V.addEventListener("submit",function(e){l.positiveButton.classList.add("working"),r.positiveButton.disabled=!0,e.preventDefault(),v.checkValidity();var t=new FormData;t.append("userId",D),t.append(T.getAttribute("name"),T.value);var s=new XMLHttpRequest;s.open("POST","/reset_password",!0),s.addEventListener("load",function(e){l.positiveButton.classList.add("working"),r.positiveButton.disabled=!1;var t=JSON.parse(s.responseText);0===t.error?l.hide():window.location="/login"}),r.element.addEventListener("neutral-pressed",function(e){n(s,r.positiveButton)}),s.send(t)}),T.addEventListener("input",function(e){T.setCustomValidity(""),this.value!==x.value&&T.setCustomValidity(PASSWORDS_DO_NOT_MATCH)}),x.addEventListener("input",function(e){T.setCustomValidity(""),this.value!==T.value&&T.setCustomValidity(PASSWORDS_DO_NOT_MATCH)}),l.element.addEventListener("positive-pressed",function(e){e.preventDefault(),M.click()}),l.element.addEventListener("hide",function(e){V.reset(),T.setCustomValidity("")}),E.addEventListener("click",function(e){c.show();var t=new XMLHttpRequest;t.open("GET","/get_user_info/"+D,!0),t.addEventListener("load",function(e){var n=JSON.parse(t.responseText);q.checked=n.info.permissions.indexOf("can_change_settings")>-1,H.checked=n.info.permissions.indexOf("can_write_posts")>-1}),t.send()}),c.element.addEventListener("positive-pressed",function(e){c.positiveButton.classList.add("working"),r.positiveButton.disabled=!0,e.preventDefault();var t=new FormData;t.append("userId",D),q.checked&&t.append(b.getAttribute("name"),"on"),H.checked&&t.append(_.getAttribute("name"),"on");var s=new XMLHttpRequest;s.open("POST","/change_user_permisisons",!0),s.addEventListener("load",function(e){c.positiveButton.classList.remove("working"),r.positiveButton.disabled=!1,c.hide()}),r.element.addEventListener("neutral-pressed",function(e){n(s,r.positiveButton)}),s.send(t)})});