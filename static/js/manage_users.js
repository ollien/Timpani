var PASSWORDS_DO_NOT_MATCH="Passwords do not match.";document.addEventListener("DOMContentLoaded",function(e){function t(e){e.addEventListener("click",function(e){k.classList.remove("fade"),u.body.classList.remove("fade"),k.style.opacity=1,u.body.style.opacity=0,u.show(),M=this.parentNode.getAttribute("user_id"),V=this.parentNode.querySelector(".username").textContent;var t=new XMLHttpRequest;t.open("GET","/get_user_info/"+M),t.addEventListener("load",function(e){var n=JSON.parse(t.responseText);0===n.error?(O.textContent=n.info.username,A.textContent=n.info.full_name,0===n.info.permissions.length?(q.style.display="",x.style.display="none"):(q.style.display="none",x.style.display="",T.style.display=n.info.permissions.indexOf("can_write_posts")>-1?"":"none",D.style.display=n.info.permissions.indexOf("can_change_settings")>-1?"":"none"),k.classList.add("fade"),u.body.classList.add("fade"),k.style.opacity="",u.body.style.opacity="",window.getComputedStyle(k).opacity,window.getComputedStyle(u.body).opacity):1===n.error&&(window.location="/login")}),t.send()})}function n(e,t){e.abort(),t.classList.remove("working"),t.disabled=!1}function i(e){userElements=y.querySelectorAll("li.user");for(var t=0;t<userElements.length;t++)if(userElements[t].querySelector("span.username").textContent.toLowerCase()>e.toLowerCase())return userElements[t];return null}var s=document.getElementById("add-user-modal"),o=document.getElementById("user-info-modal"),d=document.getElementById("change-password-modal"),a=document.getElementById("edit-permissions-modal"),r=document.getElementById("delete-modal"),l=new Modal(s);l.positiveButton=l.element.querySelector("button.positive");var u=new Modal(o);u.positiveButton=u.element.querySelector("button.positive"),u.body=u.element.querySelector("div.modal-body");var c=new Modal(d);c.positiveButton=c.element.querySelector("button.positive");var p=new Modal(a);p.positiveButton=p.element.querySelector("button.positive");var m=new Modal(r);m.positiveButton=m.element.querySelector("button.positive");var v=document.getElementById("add-user-button"),y=document.getElementById("users-list"),g=document.getElementById("create-user-form"),f=g.querySelector("button"),E=Array.prototype.slice.call(document.querySelectorAll(".user-info-button")),w=document.getElementById("change-password-button"),h=document.getElementById("edit-permissions-button"),L=document.getElementById("delete-user-button"),B=document.getElementById("username-input"),b=document.getElementById("full-name-input"),S=document.getElementById("password-input"),C=document.getElementById("confirm-password-input"),_=document.getElementById("can-change-settings-checkbox"),I=document.getElementById("can-write-posts-checkbox"),k=document.getElementById("spinner-container"),O=document.getElementById("username-display"),A=document.getElementById("full-name-display"),x=document.getElementById("permission-info"),T=document.getElementById("can-change-settings"),D=document.getElementById("can-write-posts"),q=document.getElementById("no-permissions"),M=-1,V="",N=document.getElementById("reset-password-input"),H=document.getElementById("confirm-password-reset-input"),R=document.getElementById("change-password-form"),P=R.querySelector("button"),X=document.getElementById("can-change-settings-edit-checkbox"),J=document.getElementById("can-write-posts-edit-checkbox"),W=document.getElementById("delete-username");v.addEventListener("click",function(e){l.show()}),g.addEventListener("submit",function(e){l.positiveButton.classList.add("working"),l.positiveButton.disabled=!0,e.preventDefault(),g.checkValidity();var s=new FormData;s.append(B.getAttribute("name"),B.value),s.append(b.getAttribute("name"),b.value),s.append(S.getAttribute("name"),S.value),_.checked&&s.append(_.getAttribute("name"),"on"),I.checked&&s.append(I.getAttribute("name"),"on");var o=new XMLHttpRequest;o.open("POST","/create_user"),o.addEventListener("load",function(e){var n=JSON.parse(o.responseText);if(l.positiveButton.classList.remove("working"),l.positiveButton.disabled=!1,0===n.error){var s=n.user_id,d=document.createElement("li");d.setAttribute("user_id",s),d.classList.add("user");var a=document.createElement("span");a.classList.add("username"),a.textContent=B.value,d.appendChild(a);var r=document.createElement("span");r.classList.add("user-info-button"),r.classList.add("fa"),r.classList.add("fa-info-circle"),E.push(r),t(r),d.appendChild(r),d.style.opacity=0,d.style.height="0px";var u=i(B.value);null===u?y.appendChild(d):y.insertBefore(d,u),window.getComputedStyle(d).opacity,window.getComputedStyle(d).height,d.style.opacity=1,d.style.height="",l.hide()}else 1===n.error?window.location="/login":2===n.error&&(B.setCustomValidity("Username already in use!"),f.click())}),l.element.addEventListener("neutral-pressed",function(e){n(o,l.positiveButton)}),o.send(s)}),B.addEventListener("input",function(e){this.setCustomValidity("")}),S.addEventListener("input",function(e){this.setCustomValidity(""),this.value!==C.value&&this.setCustomValidity(PASSWORDS_DO_NOT_MATCH)}),C.addEventListener("input",function(e){S.setCustomValidity(""),S.value!==this.value&&S.setCustomValidity(PASSWORDS_DO_NOT_MATCH)}),l.element.addEventListener("positive-pressed",function(e){e.preventDefault(),f.click()}),l.element.addEventListener("hide",function(e){g.reset(),S.setCustomValidity(""),C.setCustomValidity(""),B.setCustomValidity("")}),E.forEach(t),w.addEventListener("click",function(e){c.show()}),R.addEventListener("submit",function(e){c.positiveButton.classList.add("working"),l.positiveButton.disabled=!0,e.preventDefault(),g.checkValidity();var t=new FormData;t.append("userId",M),t.append(N.getAttribute("name"),N.value);var i=new XMLHttpRequest;i.open("POST","/reset_password",!0),i.addEventListener("load",function(e){c.positiveButton.classList.add("working"),l.positiveButton.disabled=!1;var t=JSON.parse(i.responseText);0===t.error?c.hide():window.location="/login"}),l.element.addEventListener("neutral-pressed",function(e){n(i,l.positiveButton)}),i.send(t)}),N.addEventListener("input",function(e){N.setCustomValidity(""),this.value!==H.value&&N.setCustomValidity(PASSWORDS_DO_NOT_MATCH)}),H.addEventListener("input",function(e){N.setCustomValidity(""),this.value!==N.value&&N.setCustomValidity(PASSWORDS_DO_NOT_MATCH)}),c.element.addEventListener("positive-pressed",function(e){e.preventDefault(),P.click()}),c.element.addEventListener("hide",function(e){R.reset(),N.setCustomValidity("")}),h.addEventListener("click",function(e){p.show();var t=new XMLHttpRequest;t.open("GET","/get_user_info/"+M,!0),t.addEventListener("load",function(e){var n=JSON.parse(t.responseText);X.checked=n.info.permissions.indexOf("can_change_settings")>-1,J.checked=n.info.permissions.indexOf("can_write_posts")>-1}),t.send()}),p.element.addEventListener("positive-pressed",function(e){p.positiveButton.classList.add("working"),l.positiveButton.disabled=!0,e.preventDefault();var t=new FormData;t.append("userId",M),X.checked&&t.append(_.getAttribute("name"),"on"),J.checked&&t.append(I.getAttribute("name"),"on");var i=new XMLHttpRequest;i.open("POST","/change_user_permisisons",!0),i.addEventListener("load",function(e){p.positiveButton.classList.remove("working"),l.positiveButton.disabled=!1,p.hide()}),l.element.addEventListener("neutral-pressed",function(e){n(i,l.positiveButton)}),i.send(t)}),L.addEventListener("click",function(e){W.textContent=V,m.show()}),m.element.addEventListener("positive-pressed",function(e){m.positiveButton.classList.add("working"),m.positiveButton.disabled=!0,e.preventDefault();var t=new XMLHttpRequest;t.open("POST","/delete_user/"+M,!0),t.addEventListener("load",function(e){var n=JSON.parse(t.responseText);if(0===n.error){m.positiveButton.classList.remove("working"),m.positiveButton.disabled=!1,m.hide(),u.hide();var i=y.querySelector('li.user[user_id = "'+M+'"]');i.addEventListener("transition-end",function(e){this.parentNode.removeChild(i)}),i.style.opacity=0,i.style.height="0px",window.getComputedStyle(li).opacity,window.getComputedStyle(li).height}else window.location="/login"}),t.send()})});